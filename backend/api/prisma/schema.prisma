generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                                                  String              @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  email                                               String              @unique @db.VarChar(255)
  phone                                               String?             @unique @db.VarChar(20)
  firstName                                           String              @map("first_name") @db.VarChar(100)
  lastName                                            String              @map("last_name") @db.VarChar(100)
  role                                                UserRole            @map("role")
  status                                              UserStatus?         @default(PENDING_VERIFICATION) @map("status")
  dateOfBirth                                         DateTime?           @map("date_of_birth") @db.Date
  address                                             String?
  city                                                String?             @db.VarChar(100)
  country                                             String?             @default("HT") @db.VarChar(2)
  language                                            String?             @default("ht") @db.VarChar(2)
  password                                            String?             @db.VarChar(255)
  pinHash                                             String?             @map("pin_hash") @db.VarChar(255)
  twoFactorEnabled                                    Boolean?            @map("two_factor_enabled") @default(false)
  createdAt                                           DateTime?           @map("created_at") @default(now()) @db.Timestamptz(6)
  updatedAt                                           DateTime?           @map("updated_at") @default(now()) @db.Timestamptz(6)
  lastLoginAt                                         DateTime?           @map("last_login_at") @db.Timestamptz(6)
  emailVerifiedAt                                     DateTime?           @map("email_verified_at") @db.Timestamptz(6)
  adminProfile                                        AdminProfile?
  auditLogs                                           AuditLog[]
  beneficiariesAsClient                               Beneficiary[]       @relation("beneficiaries_client_user_idTousers")
  beneficiariesAsDiaspora                             Beneficiary[]       @relation("beneficiaries_diaspora_user_idTousers")
  cardsIssued                                         Card[]              @relation("cards_issued_byTousers")
  cardsOwned                                          Card[]              @relation("cards_user_idTousers")
  clientProfile                                       ClientProfile?
  diasporaProfile                                     DiasporaProfile?
  distributorProfile                                  DistributorProfile?
  merchantProfile                                     MerchantProfile?
  notifications                                       Notification[]
  refillRequestsFrom                                  RefillRequest[]     @relation("refill_requests_from_user_idTousers")
  refillRequestsProcessed                             RefillRequest[]     @relation("refill_requests_processed_byTousers")
  transactionsProcessed                               Transaction[]       @relation("transactions_processed_byTousers")
  transactionsReceived                                Transaction[]       @relation("transactions_receiver_idTousers")
  transactionsSent                                    Transaction[]       @relation("transactions_sender_idTousers")
  userSessions                                        UserSession[]
  wallets                                             Wallet[]

  // üîç Enhanced Security & Financial Infrastructure Relations
  kycVerification   KYCVerification?
  kycReviews        KYCVerification[]  @relation("KYCReviewedBy")
  cardActivities    CardActivity[]
  commissionRecords CommissionRecord[]
  disputesRaised    Dispute[]          @relation("DisputeRaisedBy")
  disputesAssigned  Dispute[]          @relation("DisputeAssignedTo")
  devices           Device[]
  referralCodes     ReferralCode[]
  referralUses      ReferralUse[]
  accountRecoveries AccountRecovery[]

  // üîß Operational & Support Infrastructure Relations
  supportTickets         SupportTicket[]
  supportTicketsAssigned SupportTicket[]       @relation("TicketAssignedTo")
  posDevicesAsMerchant   POSDevice[]           @relation("POSMerchant")
  posDevicesAsDistributor POSDevice[]          @relation("POSDistributor")
  cardInventories        CardInventory[]
  appConfigs             AppConfig[]
  userActivityLogs       UserActivityLog[]
  pushNotificationLogs   PushNotificationLog[]

  payments Payment[]

  @@index([country], map: "idx_users_country")
  @@index([email], map: "idx_users_email")
  @@index([phone], map: "idx_users_phone")
  @@index([role], map: "idx_users_role")
  @@index([status], map: "idx_users_status")
  @@map("users")
}

model ClientProfile {
  id                   String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId               String    @unique @map("user_id") @db.Uuid
  preferredLanguage    String?   @map("preferred_language") @default("ht") @db.VarChar(2)
  receiveNotifications Boolean?  @map("receive_notifications") @default(true)
  preferredCurrency    String?   @map("preferred_currency") @default("HTG") @db.VarChar(3)
  createdAt            DateTime? @map("created_at") @default(now()) @db.Timestamptz(6)
  updatedAt            DateTime? @map("updated_at") @default(now()) @db.Timestamptz(6)
  user                 User      @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@map("client_profiles")
}

model MerchantProfile {
  id                    String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId                String    @unique @map("user_id") @db.Uuid
  businessName          String    @map("business_name") @db.VarChar(255)
  businessType          String    @map("business_type") @db.VarChar(100)
  businessAddress       String?   @map("business_address")
  businessPhone         String?   @map("business_phone") @db.VarChar(20)
  taxId                 String?   @map("tax_id") @db.VarChar(50)
  isVerified            Boolean?  @map("is_verified") @default(false)
  verifiedAt            DateTime? @map("verified_at") @db.Timestamptz(6)
  autoAcceptPayments    Boolean?  @map("auto_accept_payments") @default(true)
  maxTransactionAmount  Decimal?  @map("max_transaction_amount") @default(100000) @db.Decimal(15, 2)
  createdAt             DateTime? @map("created_at") @default(now()) @db.Timestamptz(6)
  updatedAt             DateTime? @map("updated_at") @default(now()) @db.Timestamptz(6)
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@map("merchant_profiles")
}

model DistributorProfile {
  id                        String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId                    String    @unique @map("user_id") @db.Uuid
  territoryName             String    @map("territory_name") @db.VarChar(255)
  territoryCode             String    @unique @map("territory_code") @db.VarChar(20)
  region                    String    @db.VarChar(100)
  isActive                  Boolean?  @map("is_active") @default(true)
  refillCommissionRate      Decimal?  @map("refill_commission_rate") @default(0.02) @db.Decimal(5, 4)
  withdrawalCommissionRate  Decimal?  @map("withdrawal_commission_rate") @default(0.02) @db.Decimal(5, 4)
  cardsInStock              Int?      @map("cards_in_stock") @default(0)
  lastRestockAt             DateTime? @map("last_restock_at") @db.Timestamptz(6)
  createdAt                 DateTime? @map("created_at") @default(now()) @db.Timestamptz(6)
  updatedAt                 DateTime? @map("updated_at") @default(now()) @db.Timestamptz(6)
  user                      User      @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@map("distributor_profiles")
}

model DiasporaProfile {
  id                   String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId               String    @unique @map("user_id") @db.Uuid
  countryOfResidence   String    @map("country_of_residence") @db.VarChar(2)
  preferredCurrency    String?   @map("preferred_currency") @default("USD") @db.VarChar(3)
  autoRefillEnabled    Boolean?  @map("auto_refill_enabled") @default(false)
  autoRefillAmount     Decimal?  @map("auto_refill_amount") @db.Decimal(15, 2)
  autoRefillFrequency  String?   @map("auto_refill_frequency") @db.VarChar(20)
  nextAutoRefillDate   DateTime? @map("next_auto_refill_date") @db.Timestamptz(6)
  createdAt            DateTime? @map("created_at") @default(now()) @db.Timestamptz(6)
  updatedAt            DateTime? @map("updated_at") @default(now()) @db.Timestamptz(6)
  user                 User      @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@map("diaspora_profiles")
}

model AdminProfile {
  id          String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId      String    @unique @map("user_id") @db.Uuid
  department  String    @db.VarChar(100)
  permissions Json?     @default("[]")
  createdAt   DateTime? @map("created_at") @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime? @map("updated_at") @default(now()) @db.Timestamptz(6)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@map("admin_profiles")
}

model Wallet {
  id                      String          @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId                  String          @map("user_id") @db.Uuid
  currency                String?         @default("HTG") @db.VarChar(3)
  balance                 Decimal?        @default(0) @db.Decimal(15, 2)
  status                  WalletStatus?   @map("status") @default(ACTIVE)
  dailyLimit              Decimal?        @map("daily_limit") @default(50000) @db.Decimal(15, 2)
  monthlyLimit            Decimal?        @map("monthly_limit") @default(500000) @db.Decimal(15, 2)
  createdAt               DateTime?       @map("created_at") @default(now()) @db.Timestamptz(6)
  updatedAt               DateTime?       @map("updated_at") @default(now()) @db.Timestamptz(6)
  refillRequests          RefillRequest[]
  transactionsReceived    Transaction[]   @relation("transactions_receiver_wallet_idTowallets")
  transactionsSent        Transaction[]   @relation("transactions_sender_wallet_idTowallets")
  user                    User            @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([userId, currency])
  @@index([currency], map: "idx_wallets_currency")
  @@index([status], map: "idx_wallets_status")
  @@index([userId], map: "idx_wallets_user_id")
  @@map("wallets")
}

model Transaction {
  id                 String             @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  type               TransactionType    @map("type")
  status             TransactionStatus? @map("status") @default(PENDING)
  amount             Decimal            @db.Decimal(15, 2)
  currency           String?            @default("HTG") @db.VarChar(3)
  fee                Decimal?           @default(0) @db.Decimal(15, 2)
  senderId           String             @map("sender_id") @db.Uuid
  receiverId         String             @map("receiver_id") @db.Uuid
  senderWalletId     String             @map("sender_wallet_id") @db.Uuid
  receiverWalletId   String             @map("receiver_wallet_id") @db.Uuid
  method             PaymentMethod      @map("method")
  reference          String             @unique @db.VarChar(100)
  description        String?
  cardId             String?            @map("card_id") @db.Uuid
  stripePaymentId    String?            @map("stripe_payment_id") @db.VarChar(255)
  processedAt        DateTime?          @map("processed_at") @db.Timestamptz(6)
  processedBy        String?            @map("processed_by") @db.Uuid
  failureReason      String?            @map("failure_reason")
  metadata           Json?
  ipAddress          String?            @map("ip_address") @db.Inet
  userAgent          String?            @map("user_agent")
  location           Json?
  createdAt          DateTime?          @map("created_at") @default(now()) @db.Timestamptz(6)
  updatedAt          DateTime?          @map("updated_at") @default(now()) @db.Timestamptz(6)
  card               Card?              @relation(fields: [cardId], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_transactions_card_id")
  processedByUser    User?              @relation("transactions_processed_byTousers", fields: [processedBy], references: [id], onDelete: NoAction, onUpdate: NoAction)
  receiver           User               @relation("transactions_receiver_idTousers", fields: [receiverId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  receiverWallet     Wallet             @relation("transactions_receiver_wallet_idTowallets", fields: [receiverWalletId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  sender             User               @relation("transactions_sender_idTousers", fields: [senderId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  senderWallet       Wallet             @relation("transactions_sender_wallet_idTowallets", fields: [senderWalletId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  // üí∞ Financial Infrastructure Relations
  commissionRecords CommissionRecord[] // Commission tracking
  disputes          Dispute[] // Dispute handling

  @@index([createdAt], map: "idx_transactions_created_at")
  @@index([receiverId], map: "idx_transactions_receiver_id")
  @@index([reference], map: "idx_transactions_reference")
  @@index([senderId], map: "idx_transactions_sender_id")
  @@index([status], map: "idx_transactions_status")
  @@index([type], map: "idx_transactions_type")
  @@map("transactions")
}

model Card {
  id           String         @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  uid          String         @unique @db.VarChar(50)
  type         CardType       @map("type")
  status       CardStatus?    @map("status") @default(INACTIVE)
  userId       String?        @map("user_id") @db.Uuid
  issuedBy     String         @map("issued_by") @db.Uuid
  issuedAt     DateTime       @map("issued_at") @db.Timestamptz(6)
  activatedAt  DateTime?      @map("activated_at") @db.Timestamptz(6)
  expiresAt    DateTime?      @map("expires_at") @db.Timestamptz(6)
  lastUsedAt   DateTime?      @map("last_used_at") @db.Timestamptz(6)
  usageCount   Int?           @map("usage_count") @default(0)
  cardNumber   String?        @unique @map("card_number") @db.VarChar(50)
  printedName  String?        @map("printed_name") @db.VarChar(255)
  createdAt    DateTime?      @map("created_at") @default(now()) @db.Timestamptz(6)
  updatedAt    DateTime?      @map("updated_at") @default(now()) @db.Timestamptz(6)
  issuer       User           @relation("cards_issued_byTousers", fields: [issuedBy], references: [id], onDelete: NoAction, onUpdate: NoAction)
  user         User?          @relation("cards_user_idTousers", fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  transactions Transaction[]
  activities   CardActivity[] // Card lifecycle tracking

  @@index([status], map: "idx_cards_status")
  @@index([type], map: "idx_cards_type")
  @@index([uid], map: "idx_cards_uid")
  @@index([userId], map: "idx_cards_user_id")
  @@map("cards")
}

model RefillRequest {
  id                String                @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  fromUserId        String                @map("from_user_id") @db.Uuid
  toWalletId        String                @map("to_wallet_id") @db.Uuid
  amount            Decimal               @db.Decimal(15, 2)
  currency          String?               @default("HTG") @db.VarChar(3)
  status            RefillRequestStatus?  @map("status") @default(PENDING)
  note              String?
  processedBy       String?               @map("processed_by") @db.Uuid
  processedAt       DateTime?             @map("processed_at") @db.Timestamptz(6)
  expiresAt         DateTime?             @map("expires_at") @default(dbgenerated("(now() + '24:00:00'::interval)")) @db.Timestamptz(6)
  stripePaymentId   String?               @map("stripe_payment_id") @db.VarChar(255)
  paymentMethod     PaymentMethod?        @map("payment_method")
  createdAt         DateTime?             @map("created_at") @default(now()) @db.Timestamptz(6)
  updatedAt         DateTime?             @map("updated_at") @default(now()) @db.Timestamptz(6)
  fromUser          User                  @relation("refill_requests_from_user_idTousers", fields: [fromUserId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  processedByUser   User?                 @relation("refill_requests_processed_byTousers", fields: [processedBy], references: [id], onDelete: NoAction, onUpdate: NoAction)
  wallet            Wallet                @relation(fields: [toWalletId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  // üí∞ Commission tracking for refill requests
  commissionRecords CommissionRecord[]

  @@index([fromUserId], map: "idx_refill_requests_from_user_id")
  @@index([status], map: "idx_refill_requests_status")
  @@index([toWalletId], map: "idx_refill_requests_to_wallet_id")
  @@map("refill_requests")
}

model Beneficiary {
  id                                          String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  diaspora_user_id                            String    @db.Uuid
  client_user_id                              String    @db.Uuid
  nickname                                    String    @db.VarChar(100)
  relationship                                String    @db.VarChar(100)
  is_verified                                 Boolean?  @default(false)
  auto_refill_enabled                         Boolean?  @default(false)
  auto_refill_amount                          Decimal?  @db.Decimal(15, 2)
  auto_refill_frequency                       String?   @db.VarChar(20)
  next_auto_refill_date                       DateTime? @db.Timestamptz(6)
  created_at                                  DateTime? @default(now()) @db.Timestamptz(6)
  updated_at                                  DateTime? @default(now()) @db.Timestamptz(6)
  users_beneficiaries_client_user_idTousers   User      @relation("beneficiaries_client_user_idTousers", fields: [client_user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users_beneficiaries_diaspora_user_idTousers User      @relation("beneficiaries_diaspora_user_idTousers", fields: [diaspora_user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([diaspora_user_id, client_user_id])
  @@index([client_user_id], map: "idx_beneficiaries_client_user_id")
  @@index([diaspora_user_id], map: "idx_beneficiaries_diaspora_user_id")
  @@map("beneficiaries")
}

model UserSession {
  id          String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  user_id     String    @db.Uuid
  token       String    @unique @db.VarChar(500)
  device_info Json?
  ip_address  String    @db.Inet
  user_agent  String?
  is_active   Boolean?  @default(true)
  expires_at  DateTime  @db.Timestamptz(6)
  created_at  DateTime? @default(now()) @db.Timestamptz(6)
  updated_at  DateTime? @default(now()) @db.Timestamptz(6)
  users       User      @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([expires_at], map: "idx_user_sessions_expires_at")
  @@index([token], map: "idx_user_sessions_token")
  @@index([user_id], map: "idx_user_sessions_user_id")
  @@map("user_sessions")
}

model AuditLog {
  id          String       @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  user_id     String?      @db.Uuid
  action      audit_action
  resource    String       @db.VarChar(100)
  resource_id String?      @db.Uuid
  old_values  Json?
  new_values  Json?
  ip_address  String       @db.Inet
  user_agent  String?
  metadata    Json?
  created_at  DateTime?    @default(now()) @db.Timestamptz(6)
  users       User?        @relation(fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([action], map: "idx_audit_logs_action")
  @@index([created_at], map: "idx_audit_logs_created_at")
  @@index([resource], map: "idx_audit_logs_resource")
  @@index([user_id], map: "idx_audit_logs_user_id")
  @@map("audit_logs")
}

model SystemConfig {
  id          String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  key         String    @unique @db.VarChar(255)
  value       Json
  description String?
  created_at  DateTime? @default(now()) @db.Timestamptz(6)
  updated_at  DateTime? @default(now()) @db.Timestamptz(6)

  @@map("system_config")
}

model ExchangeRate {
  id            String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  from_currency String    @db.VarChar(3)
  to_currency   String    @db.VarChar(3)
  rate          Decimal   @db.Decimal(15, 8)
  source        String?   @default("manual") @db.VarChar(50)
  created_at    DateTime? @default(now()) @db.Timestamptz(6)

  @@unique([from_currency, to_currency, created_at])
  @@index([created_at], map: "idx_exchange_rates_created_at")
  @@index([from_currency, to_currency], map: "idx_exchange_rates_currencies")
  @@map("exchange_rates")
}

model Notification {
  id           String               @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  user_id      String?              @db.Uuid
  type         notification_type
  status       notification_status? @default(PENDING)
  title        String               @db.VarChar(255)
  message      String
  data         Json?
  channels     String[]             @default(["in_app"])
  sent_at      DateTime?            @db.Timestamptz(6)
  delivered_at DateTime?            @db.Timestamptz(6)
  read_at      DateTime?            @db.Timestamptz(6)
  created_at   DateTime?            @default(now()) @db.Timestamptz(6)
  updated_at   DateTime?            @default(now()) @db.Timestamptz(6)
  users        User?                @relation(fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([created_at], map: "idx_notifications_created_at")
  @@index([status], map: "idx_notifications_status")
  @@index([type], map: "idx_notifications_type")
  @@index([user_id], map: "idx_notifications_user_id")
  @@map("notifications")
}

// üîç KYC (Know Your Customer) Verification
model KYCVerification {
  id                String            @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  user_id           String            @unique @db.Uuid
  document_type     kyc_document_type
  document_number   String?           @db.VarChar(100)
  document_url      String?           @db.VarChar(500) // Supabase Storage URL
  selfie_url        String?           @db.VarChar(500) // Verification selfie
  status            kyc_status        @default(PENDING)
  rejection_reason  String?
  reviewed_by       String?           @db.Uuid
  reviewed_at       DateTime?         @db.Timestamptz(6)
  expires_at        DateTime?         @db.Timestamptz(6) // Document expiry
  verification_data Json? // Additional verification metadata
  created_at        DateTime          @default(now()) @db.Timestamptz(6)
  updated_at        DateTime          @default(now()) @db.Timestamptz(6)

  user             User  @relation(fields: [user_id], references: [id], onDelete: Cascade)
  reviewed_by_user User? @relation("KYCReviewedBy", fields: [reviewed_by], references: [id])

  @@index([status], map: "idx_kyc_status")
  @@index([document_type], map: "idx_kyc_document_type")
  @@index([created_at], map: "idx_kyc_created_at")
  @@map("kyc_verifications")
}

// üí≥ Card Activity & Lifecycle Tracking
model CardActivity {
  id           String            @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  cardId       String            @map("card_id") @db.Uuid
  activityType CardActivityType  @map("activity_type")
  oldStatus    CardStatus?       @map("old_status")
  newStatus    CardStatus?       @map("new_status")
  performedBy  String?           @map("performed_by") @db.Uuid // Admin/Distributor who performed action
  reason       String? // Reason for status change
  location     Json? // GPS coordinates if applicable
  metadata     Json? // Additional activity data
  createdAt    DateTime          @map("created_at") @default(now()) @db.Timestamptz(6)

  card         Card  @relation(fields: [cardId], references: [id], onDelete: Cascade)
  performedByUser User? @relation(fields: [performedBy], references: [id])

  @@index([cardId], map: "idx_card_activity_card_id")
  @@index([activityType], map: "idx_card_activity_type")
  @@index([createdAt], map: "idx_card_activity_created_at")
  @@map("card_activities")
}

// üí∞ Commission & Profit Tracking
model CommissionRecord {
  id                String          @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  actor_id          String          @db.Uuid // Merchant or Distributor ID
  actor_role        commission_role // MERCHANT | DISTRIBUTOR
  transaction_id    String?         @db.Uuid // Related transaction
  refill_request_id String?         @db.Uuid // Related refill request
  commission_type   commission_type // TRANSACTION_FEE | REFILL_FEE | CARD_SALE
  base_amount       Decimal         @db.Decimal(15, 2) // Original transaction amount
  commission_rate   Decimal         @db.Decimal(5, 4) // Rate applied (e.g., 0.0250 = 2.5%)
  commission_amount Decimal         @db.Decimal(15, 2) // Calculated commission
  currency          String          @default("HTG") @db.VarChar(3)
  paid_out          Boolean         @default(false)
  paid_out_at       DateTime?       @db.Timestamptz(6)
  payment_reference String?         @db.VarChar(100) // Payout transaction reference
  created_at        DateTime        @default(now()) @db.Timestamptz(6)

  actor          User           @relation(fields: [actor_id], references: [id])
  transaction    Transaction?   @relation(fields: [transaction_id], references: [id])
  refill_request RefillRequest? @relation(fields: [refill_request_id], references: [id])

  @@index([actor_id], map: "idx_commission_actor_id")
  @@index([actor_role], map: "idx_commission_actor_role")
  @@index([paid_out], map: "idx_commission_paid_out")
  @@index([created_at], map: "idx_commission_created_at")
  @@map("commission_records")
}

// üõ°Ô∏è Dispute & Chargeback Handling
model Dispute {
  id                String         @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  transaction_id    String         @db.Uuid
  raised_by_id      String         @db.Uuid
  dispute_type      dispute_type // UNAUTHORIZED | CARD_NOT_PRESENT | FRAUD | OTHER
  status            dispute_status @default(PENDING)
  reason            String // User-provided reason
  description       String? // Detailed description
  evidence_urls     String[]       @default([]) // Supporting documents
  assigned_to       String?        @db.Uuid // Support agent
  resolution_note   String? // Final resolution explanation
  resolution_amount Decimal?       @db.Decimal(15, 2) // Refund amount if any
  resolved_at       DateTime?      @db.Timestamptz(6)
  created_at        DateTime       @default(now()) @db.Timestamptz(6)
  updated_at        DateTime       @default(now()) @db.Timestamptz(6)

  transaction    Transaction @relation(fields: [transaction_id], references: [id])
  raised_by      User        @relation("DisputeRaisedBy", fields: [raised_by_id], references: [id])
  assigned_agent User?       @relation("DisputeAssignedTo", fields: [assigned_to], references: [id])

  @@index([status], map: "idx_dispute_status")
  @@index([raised_by_id], map: "idx_dispute_raised_by")
  @@index([created_at], map: "idx_dispute_created_at")
  @@map("disputes")
}

// üì± Device & POS Binding for Security
model Device {
  id             String      @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  merchant_id    String      @db.Uuid
  device_id      String      @unique @db.VarChar(100) // IMEI, Serial, or UUID
  device_type    device_type // ANDROID_POS | IOS_POS | WEB_TERMINAL
  device_name    String?     @db.VarChar(100) // User-friendly name
  device_model   String?     @db.VarChar(100) // Manufacturer model
  os_version     String?     @db.VarChar(50) // Operating system version
  app_version    String?     @db.VarChar(50) // KobKlein app version
  is_active      Boolean     @default(true)
  last_seen_at   DateTime?   @db.Timestamptz(6)
  location       Json? // Last known GPS coordinates
  registered_at  DateTime    @default(now()) @db.Timestamptz(6)
  deactivated_at DateTime?   @db.Timestamptz(6)

  merchant        User            @relation(fields: [merchant_id], references: [id], onDelete: Cascade)
  device_sessions DeviceSession[]

  @@index([merchant_id], map: "idx_device_merchant_id")
  @@index([device_id], map: "idx_device_device_id")
  @@index([is_active], map: "idx_device_is_active")
  @@map("devices")
}

// üìä Device Session Tracking
model DeviceSession {
  id         String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  device_id  String    @db.Uuid
  started_at DateTime  @default(now()) @db.Timestamptz(6)
  ended_at   DateTime? @db.Timestamptz(6)
  ip_address String    @db.Inet
  location   Json? // GPS coordinates
  user_agent String?
  is_active  Boolean   @default(true)

  device Device @relation(fields: [device_id], references: [id], onDelete: Cascade)

  @@index([device_id], map: "idx_device_session_device_id")
  @@index([started_at], map: "idx_device_session_started_at")
  @@map("device_sessions")
}

// üéÅ Referral Code System for Growth
model ReferralCode {
  id           String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  code         String    @unique @db.VarChar(20)
  createdBy    String    @map("created_by") @db.Uuid
  targetRole   UserRole  @map("target_role") // Which role this code targets
  rewardAmount Decimal?  @map("reward_amount") @db.Decimal(15, 2) // Bonus for successful referral
  usageLimit   Int?      @map("usage_limit") @default(1) // How many times it can be used
  usageCount   Int       @map("usage_count") @default(0)
  expiresAt    DateTime? @map("expires_at") @db.Timestamptz(6)
  isActive     Boolean   @map("is_active") @default(true)
  createdAt    DateTime  @map("created_at") @default(now()) @db.Timestamptz(6)

  createdByUser User          @relation(fields: [createdBy], references: [id])
  referralUses  ReferralUse[]

  @@index([code], map: "idx_referral_code_code")
  @@index([isActive], map: "idx_referral_code_is_active")
  @@map("referral_codes")
}

// üìà Referral Usage Tracking
model ReferralUse {
  id               String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  referral_code_id String   @db.Uuid
  used_by          String   @db.Uuid // New user who used the code
  reward_given     Boolean  @default(false)
  reward_amount    Decimal? @db.Decimal(15, 2)
  used_at          DateTime @default(now()) @db.Timestamptz(6)

  referral_code ReferralCode @relation(fields: [referral_code_id], references: [id])
  user          User         @relation(fields: [used_by], references: [id])

  @@index([referral_code_id], map: "idx_referral_use_code_id")
  @@index([used_by], map: "idx_referral_use_used_by")
  @@map("referral_uses")
}

// üåç Multi-Currency Support
model Currency {
  id             String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  code           String   @unique @db.VarChar(3) // 'HTG', 'USD', 'EUR'
  name           String   @db.VarChar(100) // 'Haitian Gourde'
  symbol         String   @db.VarChar(10) // 'G', '$', '‚Ç¨'
  rate_to_htg    Decimal  @db.Decimal(15, 8) // Exchange rate to HTG base
  is_default     Boolean  @default(false) // Is this the system default?
  is_active      Boolean  @default(true) // Can be used for transactions?
  decimal_places Int      @default(2) // Number of decimal places
  updated_at     DateTime @default(now()) @db.Timestamptz(6)
  created_at     DateTime @default(now()) @db.Timestamptz(6)

  @@index([code], map: "idx_currency_code")
  @@index([is_active], map: "idx_currency_is_active")
  @@map("currencies")
}

// üîê Account Recovery Attempts
model AccountRecovery {
  id                String          @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  email_or_phone    String          @db.VarChar(255) // User's identifier
  recovery_method   recovery_method // OTP | VERIFICATION_QUESTIONS | MANUAL
  status            recovery_status @default(PENDING)
  verification_code String?         @db.VarChar(10) // OTP code
  verification_data Json? // Answers to security questions
  attempts_count    Int             @default(0)
  max_attempts      Int             @default(3)
  ip_address        String          @db.Inet
  user_agent        String?
  case_id           String?         @unique @db.VarChar(10) // For manual recovery
  assigned_to       String?         @db.Uuid // Support agent
  resolved_at       DateTime?       @db.Timestamptz(6)
  expires_at        DateTime        @db.Timestamptz(6)
  created_at        DateTime        @default(now()) @db.Timestamptz(6)

  assigned_agent User? @relation(fields: [assigned_to], references: [id])

  @@index([email_or_phone], map: "idx_recovery_email_phone")
  @@index([status], map: "idx_recovery_status")
  @@index([case_id], map: "idx_recovery_case_id")
  @@index([created_at], map: "idx_recovery_created_at")
  @@map("account_recoveries")
}

// üé´ Support Ticket System for Customer Service
model SupportTicket {
  id                String              @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  ticket_number     String              @unique @db.VarChar(20) // Auto-generated: TKT-20241201-001
  user_id           String              @db.Uuid
  type              support_ticket_type // TECHNICAL | DISPUTE | CARD_ISSUE | ACCOUNT | PAYMENT
  priority          support_priority    @default(MEDIUM) // LOW | MEDIUM | HIGH | URGENT
  status            support_status      @default(OPEN) // OPEN | IN_PROGRESS | WAITING_USER | RESOLVED | CLOSED
  subject           String              @db.VarChar(255)
  description       String // Detailed issue description
  attachments       String[]            @default([]) // URLs to uploaded files
  assigned_to       String?             @db.Uuid // Support agent ID
  resolution        String? // Final resolution details
  customer_rating   Int? // 1-5 star rating
  customer_feedback String? // Post-resolution feedback
  resolved_at       DateTime?           @db.Timestamptz(6)
  closed_at         DateTime?           @db.Timestamptz(6)
  last_response_at  DateTime?           @db.Timestamptz(6)
  response_due_at   DateTime?           @db.Timestamptz(6) // SLA deadline
  created_at        DateTime            @default(now()) @db.Timestamptz(6)
  updated_at        DateTime            @default(now()) @db.Timestamptz(6)

  user           User  @relation(fields: [user_id], references: [id], onDelete: Cascade)
  assigned_agent User? @relation("TicketAssignedTo", fields: [assigned_to], references: [id])

  @@index([status], map: "idx_support_ticket_status")
  @@index([type], map: "idx_support_ticket_type")
  @@index([priority], map: "idx_support_ticket_priority")
  @@index([user_id], map: "idx_support_ticket_user_id")
  @@index([assigned_to], map: "idx_support_ticket_assigned_to")
  @@index([created_at], map: "idx_support_ticket_created_at")
  @@map("support_tickets")
}

// üì± POS Device Management & Tracking
model POSDevice {
  id                  String            @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  serial_number       String            @unique @db.VarChar(50)
  model               String            @db.VarChar(100) // 'KobKlein-POS-V2'
  firmware_version    String            @db.VarChar(20) // '2.1.4'
  merchant_id         String?           @db.Uuid // Assigned merchant
  distributor_id      String            @db.Uuid // Responsible distributor
  status              pos_device_status @default(IN_STOCK) // IN_STOCK | ASSIGNED | ACTIVE | INACTIVE | DEFECTIVE
  location            Json? // GPS coordinates
  last_checkin_at     DateTime?         @db.Timestamptz(6) // Last heartbeat
  last_transaction_at DateTime?         @db.Timestamptz(6) // Last successful transaction
  total_transactions  Int               @default(0) // Lifetime transaction count
  total_amount        Decimal           @default(0) @db.Decimal(15, 2) // Lifetime processed amount
  assigned_at         DateTime?         @db.Timestamptz(6)
  warranty_expires_at DateTime?         @db.Timestamptz(6)
  created_at          DateTime          @default(now()) @db.Timestamptz(6)
  updated_at          DateTime          @default(now()) @db.Timestamptz(6)

  merchant    User? @relation("POSMerchant", fields: [merchant_id], references: [id])
  distributor User  @relation("POSDistributor", fields: [distributor_id], references: [id])

  @@index([serial_number], map: "idx_pos_device_serial")
  @@index([status], map: "idx_pos_device_status")
  @@index([merchant_id], map: "idx_pos_device_merchant_id")
  @@index([distributor_id], map: "idx_pos_device_distributor_id")
  @@index([last_checkin_at], map: "idx_pos_device_last_checkin")
  @@map("pos_devices")
}

// üí≥ Card Inventory & Batch Management
model CardInventory {
  id                  String           @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  batchId             String           @unique @map("batch_id") @db.VarChar(30) // BATCH-HTG-20241201-001
  distributorId       String           @map("distributor_id") @db.Uuid
  cardType            CardType         @map("card_type") // NFC | VIRTUAL
  quantityOrdered     Int              @map("quantity_ordered") // How many were ordered
  quantityReceived    Int?             @map("quantity_received") // How many actually arrived
  quantityDistributed Int              @map("quantity_distributed") @default(0) // How many given to merchants
  quantityRemaining   Int              @map("quantity_remaining") // Current stock level
  unitCost            Decimal          @map("unit_cost") @db.Decimal(10, 2) // Cost per card
  totalCost           Decimal          @map("total_cost") @db.Decimal(15, 2) // Total batch cost
  supplier            String?          @db.VarChar(200) // Card manufacturer
  batchStatus         CardBatchStatus  @map("batch_status") @default(ORDERED) // ORDERED | SHIPPED | RECEIVED | DISTRIBUTED
  orderedAt           DateTime         @map("ordered_at") @default(now()) @db.Timestamptz(6)
  shippedAt           DateTime?        @map("shipped_at") @db.Timestamptz(6)
  receivedAt          DateTime?        @map("received_at") @db.Timestamptz(6)
  expiryDate          DateTime?        @map("expiry_date") @db.Date // When cards expire
  notes               String? // Additional batch notes
  createdAt           DateTime         @map("created_at") @default(now()) @db.Timestamptz(6)
  updatedAt           DateTime         @map("updated_at") @default(now()) @db.Timestamptz(6)

  distributor User @relation(fields: [distributorId], references: [id])

  @@index([batchId], map: "idx_card_inventory_batch_id")
  @@index([distributorId], map: "idx_card_inventory_distributor_id")
  @@index([batchStatus], map: "idx_card_inventory_status")
  @@index([orderedAt], map: "idx_card_inventory_ordered_at")
  @@map("card_inventories")
}

// ‚öôÔ∏è Application Configuration Management
model AppConfig {
  id          String      @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  key         String      @unique @db.VarChar(100) // 'min_refill_amount', 'max_daily_limit'
  value       String      @db.Text // JSON string or plain value
  description String?     @db.VarChar(500) // Human-readable description
  category    String?     @db.VarChar(50) // 'financial', 'security', 'ui'
  data_type   config_type @default(STRING) // STRING | NUMBER | BOOLEAN | JSON
  is_public   Boolean     @default(false) // Can be accessed by frontend?
  updated_by  String      @db.Uuid // Admin who last updated
  created_at  DateTime    @default(now()) @db.Timestamptz(6)
  updated_at  DateTime    @default(now()) @db.Timestamptz(6)

  updated_by_user User @relation(fields: [updated_by], references: [id])

  @@index([key], map: "idx_app_config_key")
  @@index([category], map: "idx_app_config_category")
  @@index([is_public], map: "idx_app_config_is_public")
  @@map("app_configs")
}

// üìä User Activity Audit Log (Enhanced)
model UserActivityLog {
  id               String             @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  user_id          String             @db.Uuid
  activity_type    user_activity_type // LOGIN | LOGOUT | TRANSACTION | REFILL | KYC_ATTEMPT
  activity_details Json? // Activity-specific data
  ip_address       String             @db.Inet
  user_agent       String?
  device_info      Json? // Device fingerprint data
  location         Json? // GPS coordinates if available
  session_id       String?            @db.Uuid
  result           activity_result // SUCCESS | FAILED | BLOCKED
  risk_score       Decimal?           @db.Decimal(3, 2) // 0.00-1.00 fraud risk score
  created_at       DateTime           @default(now()) @db.Timestamptz(6)

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id], map: "idx_user_activity_user_id")
  @@index([activity_type], map: "idx_user_activity_type")
  @@index([result], map: "idx_user_activity_result")
  @@index([created_at], map: "idx_user_activity_created_at")
  @@index([risk_score], map: "idx_user_activity_risk_score")
  @@map("user_activity_logs")
}

// üì≤ Push Notification & Communication Log
model PushNotificationLog {
  id                String               @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  user_id           String               @db.Uuid
  notification_type notification_type // TRANSACTION | SECURITY | MARKETING | SYSTEM
  channel           notification_channel // PUSH | EMAIL | SMS | IN_APP
  title             String               @db.VarChar(255)
  message           String               @db.Text
  delivery_status   delivery_status      @default(PENDING) // PENDING | SENT | DELIVERED | FAILED | BOUNCED
  provider          String?              @db.VarChar(50) // 'firebase', 'sendgrid', 'twilio'
  provider_id       String?              @db.VarChar(100) // External provider message ID
  error_message     String? // Error details if failed
  delivered_at      DateTime?            @db.Timestamptz(6)
  opened_at         DateTime?            @db.Timestamptz(6) // When user opened notification
  clicked_at        DateTime?            @db.Timestamptz(6) // When user clicked CTA
  metadata          Json? // Provider-specific data
  created_at        DateTime             @default(now()) @db.Timestamptz(6)

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id], map: "idx_push_notification_user_id")
  @@index([delivery_status], map: "idx_push_notification_status")
  @@index([channel], map: "idx_push_notification_channel")
  @@index([created_at], map: "idx_push_notification_created_at")
  @@map("push_notification_logs")
}

// ========================== ENUMS ==========================

enum audit_action {
  CREATE
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  TRANSACTION
  ADMIN_ACTION
}

enum CardStatus {
  INACTIVE
  ACTIVE
  BLOCKED
  EXPIRED
  LOST
  STOLEN

  @@map("card_status")
}

enum CardType {
  CLIENT
  MERCHANT
  DISTRIBUTOR

  @@map("card_type")
}

enum notification_status {
  PENDING
  SENT
  DELIVERED
  FAILED
}

enum notification_type {
  TRANSACTION
  REFILL
  SECURITY
  SYSTEM
  MARKETING
}

enum PaymentMethod {
  NFC
  QR_CODE
  CARD
  BANK_TRANSFER
  CASH
  APPLE_PAY
  GOOGLE_PAY

  @@map("payment_method")
}

enum RefillRequestStatus {
  PENDING
  APPROVED
  REJECTED
  COMPLETED
  EXPIRED

  @@map("refill_request_status")
}

enum TransactionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
  REVERSED

  @@map("transaction_status")
}

enum TransactionType {
  SEND
  RECEIVE
  REFILL
  WITHDRAW
  PAYMENT
  COMMISSION
  FEE
  EXCHANGE

  @@map("transaction_type")
}

enum UserRole {
  CLIENT
  MERCHANT
  DISTRIBUTOR
  DIASPORA
  ADMIN
  SUPER_ADMIN
  REGIONAL_MANAGER
  SUPPORT_AGENT

  @@map("user_role")
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  BANNED
  PENDING_VERIFICATION

  @@map("user_status")
}

enum WalletStatus {
  ACTIVE
  FROZEN
  SUSPENDED

  @@map("wallet_status")
}

// üîê KYC Document Types
enum kyc_document_type {
  NATIONAL_ID
  PASSPORT
  DRIVERS_LICENSE
  BIRTH_CERTIFICATE
  UTILITY_BILL
}

// üîê KYC Verification Status
enum kyc_status {
  PENDING
  UNDER_REVIEW
  APPROVED
  REJECTED
  EXPIRED
  RESUBMISSION_REQUIRED
}

// üí≥ Card Activity Types
enum CardActivityType {
  ISSUED
  ACTIVATED
  BLOCKED
  UNBLOCKED
  REPORTED_LOST
  REPORTED_STOLEN
  EXPIRED
  DESTROYED
  REISSUED

  @@map("card_activity_type")
}

// üí∞ Commission Actor Roles
enum commission_role {
  MERCHANT
  DISTRIBUTOR
  REGIONAL_MANAGER
}

// üí∞ Commission Types
enum commission_type {
  TRANSACTION_FEE
  REFILL_FEE
  CARD_SALE
  MONTHLY_BONUS
  REFERRAL_BONUS
}

// üõ°Ô∏è Dispute Types
enum dispute_type {
  UNAUTHORIZED_TRANSACTION
  CARD_NOT_PRESENT
  SUSPECTED_FRAUD
  BILLING_ERROR
  PRODUCT_NOT_RECEIVED
  OTHER
}

// üõ°Ô∏è Dispute Status
enum dispute_status {
  PENDING
  UNDER_INVESTIGATION
  ESCALATED
  RESOLVED_FAVOR_CUSTOMER
  RESOLVED_FAVOR_MERCHANT
  CLOSED
}

// üì± Device Types
enum device_type {
  ANDROID_POS
  IOS_POS
  WEB_TERMINAL
  MOBILE_APP
  KIOSK
}

// üîê Account Recovery Methods
enum recovery_method {
  OTP_SMS
  OTP_EMAIL
  VERIFICATION_QUESTIONS
  MANUAL_REVIEW
  BIOMETRIC
}

// üîê Account Recovery Status
enum recovery_status {
  PENDING
  CODE_SENT
  VERIFIED
  FAILED
  EXPIRED
  ESCALATED
  RESOLVED
}

// üé´ Support Ticket System Enums
enum support_ticket_type {
  TECHNICAL
  DISPUTE
  CARD_ISSUE
  ACCOUNT
  PAYMENT
  FRAUD_REPORT
  BILLING
  OTHER
}

enum support_priority {
  LOW
  MEDIUM
  HIGH
  URGENT
  CRITICAL
}

enum support_status {
  OPEN
  IN_PROGRESS
  WAITING_USER
  ESCALATED
  RESOLVED
  CLOSED
}

// üì± POS Device Management Enums
enum pos_device_status {
  IN_STOCK
  ASSIGNED
  ACTIVE
  INACTIVE
  MAINTENANCE
  DEFECTIVE
  RECALLED
}

// üí≥ Card Inventory Management Enums
enum CardBatchStatus {
  ORDERED
  SHIPPED
  IN_TRANSIT
  RECEIVED
  DISTRIBUTED
  CANCELLED

  @@map("card_batch_status")
}

// ‚öôÔ∏è App Configuration Enums
enum config_type {
  STRING
  NUMBER
  BOOLEAN
  JSON
  ARRAY
}

// üìä User Activity Types
enum user_activity_type {
  LOGIN
  LOGOUT
  TRANSACTION_SEND
  TRANSACTION_RECEIVE
  REFILL_REQUEST
  REFILL_COMPLETE
  KYC_ATTEMPT
  KYC_APPROVAL
  PASSWORD_CHANGE
  PIN_CHANGE
  DEVICE_REGISTER
  CARD_ACTIVATION
  DISPUTE_RAISED
  SUPPORT_TICKET
  ACCOUNT_RECOVERY
}

// üìä Activity Results
enum activity_result {
  SUCCESS
  FAILED
  BLOCKED
  CANCELLED
  TIMEOUT
  FRAUD_DETECTED
}

// üì≤ Notification Channels
enum notification_channel {
  PUSH
  EMAIL
  SMS
  IN_APP
  WHATSAPP
}

// üì≤ Delivery Status
enum delivery_status {
  PENDING
  SENT
  DELIVERED
  FAILED
  BOUNCED
  OPENED
  CLICKED
}

// Payment status enum for Payment model
enum payment_status {
  PENDING
  SUCCEEDED
  FAILED
  REFUNDED
  CANCELLED
}

model Payment {
  id              String          @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId          String          @db.Uuid
  method          PaymentMethod
  status          payment_status  @default(PENDING)
  amount          Decimal         @db.Decimal(15, 2)
  currency        String          @default("HTG") @db.VarChar(3)
  reference       String          @unique @db.VarChar(100)
  stripePaymentId String?         @db.VarChar(255)
  description     String?
  createdAt       DateTime        @default(now()) @db.Timestamptz(6)
  updatedAt       DateTime        @default(now()) @db.Timestamptz(6)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], map: "idx_payments_user_id")
  @@index([status], map: "idx_payments_status")
  @@map("payments")
}
